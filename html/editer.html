<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="img/icon.png" type="image/png">

    <title>AirLockUnlock - Modifier un bien</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #007BFF;
            --secondary: #0056b3;
            --accent: #f59e0b;
            --light: #f8fafc;
            --dark: #1e293b;
            --success: #10b981;
            --gray: #94a3b8;
            --light-gray: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary);
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo img {
            width: 2.5rem;
            height: 2.5rem;
        }

        .logo-text {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            gap: 0.5rem;
        }

        .btn-logout {
            background-color: transparent;
            color: white;
            border: 1px solid white;
        }

        .btn-logout:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 1.5rem;
        }

        .form-container {
            background-color: white;
            border-radius: 0.5rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--primary);
            border: 1px solid var(--light-gray);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: var(--light-gray);
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            gap: 0.5rem;
            background-color: var(--light);
            color: var(--primary);
            border: 1px solid var(--light-gray);
            margin-bottom: 1.5rem;
        }

        .btn-back:hover {
            background-color: var(--light-gray);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        footer {
            background-color: var(--primary);
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-links {
            display: flex;
            gap: 1.5rem;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--accent);
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .form-row {
                flex-direction: column;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="img/logo.png" alt="AirLockUnlock Logo">
            <span class="logo-text">AirLockUnlock</span>
        </div>
        <a href="index.html" class="btn btn-logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
    </header>
    <div class="container">
        <a href="gerer.html" class="btn-back"><i class="fas fa-arrow-left"></i> Retour à la gestion des biens</a>

        <section class="edit-property-section">
            <h2 class="section-title">Modifier un bien</h2>

            <div class="form-container">
                <form id="editPropertyForm">
                    <input type="hidden" id="id_bien" name="id_bien">
                    
                    <div class="form-group">
                        <label for="titre">Titre du bien</label>
                        <input type="text" id="titre" name="titre" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" class="form-control" rows="4" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="type">Type de bien</label>
                            <select id="type" name="type" class="form-control" required>
                                <option value="appartement">Appartement</option>
                                <option value="maison">Maison</option>
                                <option value="studio">Studio</option>
                                <option value="loft">Loft</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="prix">Prix (€/mois)</label>
                            <input type="number" id="prix" name="prix" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="surface">Surface (m²)</label>
                            <input type="number" id="surface" name="surface" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="nb_pieces">Nombre de pièces</label>
                            <input type="number" id="nb_pieces" name="nb_pieces" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="localisation">Adresse complète</label>
                        <input type="text" id="localisation" name="localisation" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Photos du bien</label>
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="photos" name="photos" accept="image/*" multiple>
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">Cliquez pour télécharger ou glissez-déposez</div>
                            <div class="upload-hint">JPG ou PNG, max 5MB par image</div>
                        </div>
                        <div class="preview-container" id="previewContainer"></div>
                    </div>

                    <div class="form-group">
                        <label for="id_serrure_tapkey">ID de la serrure Tapkey</label>
                        <input type="text" id="id_serrure_tapkey" name="id_serrure_tapkey" class="form-control" required>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='gerer'">Annuler</button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 AirLockUnlock. Tous droits réservés.</p>
            <div class="footer-links">
                <a href="#">Confidentialité</a>
                <a href="#">Conditions</a>
                <a href="#">Contact</a>
            </div>
        </div>
    </footer>

    <script>
                // Fonction pour supprimer un cookie
        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
        }

        // Fonction pour gérer la déconnexion
        function handleLogout(event) {
            event.preventDefault(); // Empêcher le comportement par défaut du lien
            deleteCookie('auth_token'); // Supprimer le cookie contenant le token
            window.location.href = 'index.html'; // Rediriger vers la page de connexion
        }

        // Ajouter un gestionnaire d'événements pour la déconnexion
        document.addEventListener('DOMContentLoaded', function() {
            const logoutLink = document.querySelector('.profile-menu a[href="index"]');
            if (logoutLink) {
                logoutLink.addEventListener('click', handleLogout);
            }
        });

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
    
        const bienId = getQueryParam('id');
        const token = getCookie('auth_token');
    
        if (!bienId) {
            alert("ID du bien manquant dans l'URL");
            window.location.href = 'gerer.html';
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('auth_token'); // ou comment tu récupères ton token
            const bienId = getIdFromUrl(); // ta fonction pour extraire l'id_bien de l'URL

            if (token && bienId) {
                const apiHost = window.location.hostname;
                fetch(`https://airlockunlock.alwaysdata.net/AirlockUnlock/bien/biens.php?id=${bienId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Erreur réseau');
                    return response.json();
                })
                .then(data => {
                    const bien = Array.isArray(data) ? data[0] : data;

                    if (!bien) throw new Error('Bien non trouvé');

                    // Remplir le formulaire avec les noms de champs adaptés
                    document.getElementById('id_bien').value = bien.id_bien || '';
                    document.getElementById('titre').value = bien.titre || '';
                    document.getElementById('description').value = bien.description || '';
                    document.getElementById('type').value = bien.type_bien?.toLowerCase() || 'appartement';
                    document.getElementById('prix').value = bien.prix_par_nuit || '';
                    document.getElementById('surface').value = bien.surface || '';
                    document.getElementById('nb_pieces').value = bien.nombre_pieces || '';
                    document.getElementById('localisation').value = bien.adresse || '';
                    document.getElementById('photo_url').value = bien.photo_url || '';
                    document.getElementById('id_serrure_tapkey').value = bien.numero_serie_tapkey || '';
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors du chargement du bien: ' + error.message);
                    window.location.href = 'gerer.html';
                });
            }
        });

    
        document.getElementById('editPropertyForm').addEventListener('submit', function(e) {
            e.preventDefault();
    
            if (!token) {
                alert('Session expirée, veuillez vous reconnecter');
                window.location.href = 'index.html';
                return;
            }
    
            // Valider que id_bien est présent
            const id_bien_val = document.getElementById('id_bien').value;
            if (!id_bien_val) {
                alert("L'ID du bien est requis pour la modification.");
                return;
            }
    
            // Récupérer les valeurs du formulaire et les mapper aux noms attendus par l'API
            const payload = {
                id_bien: id_bien_val,
                titre: document.getElementById('titre').value,
                description: document.getElementById('description').value,
                type_bien: document.getElementById('type').value.charAt(0).toUpperCase() + document.getElementById('type').value.slice(1), // Majuscule initiale
                prix_par_nuit: document.getElementById('prix').value,
                surface: parseFloat(document.getElementById('surface').value),
                nombre_pieces: parseInt(document.getElementById('nb_pieces').value, 10),
                adresse: document.getElementById('localisation').value,
                photo_url: document.getElementById('photo_url').value,
                numero_serie_tapkey: document.getElementById('id_serrure_tapkey').value || null // Peut être vide
            };
    
        const apiHost = window.location.hostname;

        fetch(`https://airlockunlock.alwaysdata.net/AirlockUnlock/bien/editer.php`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Erreur serveur'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Bien mis à jour avec succès!');

        // Suppression du bien juste après la mise à jour
        fetch(`https://airlockunlock.alwaysdata.net/AirlockUnlock/bien/supprimer.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                id_bien: payload.id_bien,
                id_proprietaire: getCookie('id_proprietaire') // Assure-toi que ce cookie est bien défini
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Bien supprimé avec succès.');
                window.location.href = 'gerer';
            } else {
                throw new Error(data.error || 'Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Erreur de suppression:', error);
            alert('Erreur lors de la suppression: ' + error.message);
        });

    } else {
        throw new Error(data.message || 'Erreur lors de la mise à jour');
    }
})
.catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de la mise à jour: ' + error.message);
});
});
    </script>

</body>
</html>
